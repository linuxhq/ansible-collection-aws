---
- name: Verify
  hosts: all
  environment:
    PATH: "/opt/awscli/bin:{{ ansible_env.PATH }}"

  roles:
    - iam_instance_profile_info

  post_tasks:
    - name: Ensure info is verified
      ansible.builtin.assert:
        that:
          - _iam_instance_profile_info_dict['molecule-instance-profile-ec2'].instance_profile_id is defined
          - _iam_instance_profile_info_dict['molecule-instance-profile-ec2'].instance_profile_name is defined
          - _iam_instance_profile_info_dict['molecule-instance-profile-ec2'].roles.0.role_name ==
              iam_instance_profile_list.0.role
          - _iam_instance_profile_info_dict['molecule-instance-profile-vpc'].instance_profile_id is defined
          - _iam_instance_profile_info_dict['molecule-instance-profile-vpc'].instance_profile_name is defined
          - _iam_instance_profile_info_dict['molecule-instance-profile-vpc'].roles.0.role_name ==
              iam_instance_profile_list.1.role

    - name: Ensure inventory lists are formatted
      ansible.builtin.set_fact:
        iam_instance_profile_list:
          "{{ iam_instance_profile_list |
              map('combine', {'state': 'absent'}) }}"
        iam_role_list:
          "{{ iam_role_list |
              map('combine', {'state': 'absent'}) }}"

    - name: Ensure roles are included
      ansible.builtin.include_role:
        name: "{{ _role }}"
      loop:
        - iam_instance_profile
        - iam_role
      loop_control:
        label: "{{ _role }}"
        loop_var: _role
...
